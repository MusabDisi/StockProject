{% extends "base.html" %}
{% block content %}
<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>


<div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
	<label class="mdl-button mdl-js-button mdl-button--icon" for="searchFeild">
		<i class="material-icons" id="searchIcon">search</i>
	</label>
	<div class="mdl-textfield__expandable-holder">
		<input class="mdl-textfield__input" type="text" id="searchFeild" placeholder="Search">
		<label class="mdl-textfield__label"></label>
	</div>
</div>

<div class=" index">
	<div id="table" class="ag-theme-material"></div>
</div>

<style>
	#table {
		height: 600px;
		width: 100%;
	}

	#searchFeild {
		padding-bottom: 8px;
		border: none;
	}

	#searchIcon {
		color: #3492eb;
	}
</style>

<script type='text/javascript'>
	const fav = 	JSON.parse('{{ favorite_stocks|escapejs }}').map(elm => elm.pk)
	const columnsDef = [
		{ headerName: "Rank", field: "rank", sortable: true, cellStyle: { textAlign: 'left' } },
		{ headerName: "Symbol", field: "symbol", sortable: true, filter: true, cellStyle: { textAlign: 'left' } },
		{ headerName: "Name", field: "name", sortable: true, filter: true, cellStyle: { textAlign: 'left', width: '300px' }, resizable: true },
		{ headerName: "Price", field: "price", sortable: true, cellStyle: { textAlign: 'left' } },
		{ headerName: "Change", field: "change", sortable: true, cellStyle: cellColor }
	];

	function cellColor(params) {
		if (params.value.includes('-'))
			return { color: 'red', textAlign: 'left' };
		return { color: 'green', textAlign: 'left' };
	}

	var rowData = [];

	const gridOptions = {
		columnDefs: columnsDef,
		rowData: rowData,
		onFirstDataRendered: makeColumnsFit,
		rowSelection: 'single',
		onRowClicked: function (event) {
			window.location.href = 'stock/' + event.data.symbol;
		},

	};

	function makeColumnsFit(params) {
		params.api.sizeColumnsToFit();
	}

	$(document).ready(function () {
		// Get data from django as a json
		var data = JSON.parse('{{ data|escapejs }}');
		initTable(data);
		initSearchBar();
	});

	function initSearchBar() {
		$('#searchFeild').keyup(function () {
			gridOptions.api.setQuickFilter($('#searchFeild').val());
		});
	}

	function initTable(data) {
		// Add data
		data.forEach(function (stock) {
			fields = stock['fields'];
			fav_icon = fav.includes(stock['pk'])? '⭐️' : ''
			rowData.push({
				rank: fields['top_rank'] + fav_icon,
				symbol: stock['pk'],
				name: fields['name'],
				price: fields['price'],
				change: (fields['change'] < 0 ? '▼ ' : '▲ ') + fields['change'] + '%'
			});
		});

		// Show the grid
		new agGrid.Grid($('.index #table')[0], gridOptions);
		gridOptions.api.sizeColumnsToFit();
	}

</script>

{% endblock %}
