{% extends "base.html" %}

{% block content %}
    <div class="">
        <h3> Budget {{user_budget}}
    </div>

    <div class="row justify-content-md-center">
        <div class="table-responsive col-md-6">
            <div> <p>Stocks to Sell</p></div>
            {% comment %} add to sell with search {% endcomment %}
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
                <label class="mdl-button mdl-js-button mdl-button--icon" for="searchFeild">
                    <i class="material-icons" id="searchBuyIcon">search</i>
                </label>
                <div class="mdl-textfield__expandable-holder">
                    <input class="mdl-textfield__input" type="text" id="searchFeild" placeholder="Search">
                    <label class="mdl-textfield__label"></label>
                </div>
            </div>

            <div class=" index">
                <div id="buytable" class="ag-theme-material"></div>
            </div>

        </div>
        {% comment %} This end {% endcomment %}
        <div class="table-responsive col-md-6">
            <div> <p>Stocks to Sell</p></div>

            <table class="table table-hover data-table ">
                <tr>
                    <th>Symbol</th>
                    <th>Price</th>
                    <th>Number</th>
                </tr>
                {% for user_stock in user_stocks %}
                    <tr onclick="getColumnValue('sell', '{{ user_stock.stock.symbol }}')" >
                        <td>{{ user_stock.stock.symbol }}</td>
                        <td>{{ user_stock.stock.price}}</td>
                        <td>{{ user_stock.stock_number}}</td>

                    </tr>
                {% endfor %}
            </table>
        </div>


<div class="modal" id="buyModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title" id="modal_title"></h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            
            <!-- Modal body -->
            <div class="modal-body">
                <input name="stock_name" id="buy_stock_name" required class="form-control" disabled type="text">
                <input name="stock_number" id="buy_stock_number" required class="form-control" placeholder="Stock Number" type="number">
            </div>
            
            <!-- Modal footer -->
            <div class="modal-footer">
                <div class="row justify-content-end">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success" id='modal_action_btn' onclick="buyStock()">Buy</button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        
        </div>
    </div>
</div>


<style>
	#buytable {
		height: 600px;
		width: 100%;
	}

	#searchFeild {
		padding-bottom: 8px;
		border: none;
	}

	#searchBuyIcon {
		color: #3492eb;
	}
</style>
{% endblock %}
{% block scripts %}
<script>
function getColumnValue(operation, stock_symble){
        $('#modal_title').text(operation + '  Stocks')
        $('#modal_action_btn').text(operation)
        $("#buy_stock_name").val(stock_symble);
        $("#buyModal").modal('show');
}
function buyStock(){
    let stock_symble = $("#buy_stock_name").val()
    let stock_number = $("#buy_stock_number").val()
    let operation = $("#modal_action_btn").text()
    if (!stock_number) {
        alert(`Please Set Stock number to ${operation}`)
        return 
    }
    method = operation == 'buy' ? 'POST': 'DELETE' 
    $.ajax({
            url: '{% url 'buy_stocks' %}',
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            method: method,
            data: {
                'symbol': stock_symble,
                'stock_number': stock_number
            },
            dataType: 'json',
            success: function (data) {
                if (data.error){
                    alert(data.error)
                }
                else {
                    location.reload(true);
                }

                }
        });
    $("#buyModal").modal('hide');
}
 {% comment %} This to search grid {% endcomment %}
const columnsDef = [
		{ headerName: "Symbol", field: "symbol", sortable: true, filter: true, cellStyle: { textAlign: 'left' } },
		{ headerName: "Price", field: "price", sortable: true, cellStyle: { textAlign: 'left' } },
		{ headerName: "Change", field: "change", sortable: true, cellStyle: cellColor }
	];

	function cellColor(params) {
		if (params.value.includes('-'))
			return { color: 'red', textAlign: 'left' };
		return { color: 'green', textAlign: 'left' };
	}

	var rowData = [];

	const gridOptions = {
		columnDefs: columnsDef,
		rowData: rowData,
		onFirstDataRendered: makeColumnsFit,
		rowSelection: 'single',
		onRowClicked: (event) => {
            getColumnValue('buy', event.data.symbol)
		},

	};

	function makeColumnsFit(params) {
		params.api.sizeColumnsToFit();
	}

	$(document).ready(function () {
		// Get stocks from django as a json
		var stocks = JSON.parse('{{ stocks|escapejs }}');
		initTable(stocks);
		initSearchBar();
	});

	function initSearchBar() {
		$('#searchFeild').keyup(function () {
			gridOptions.api.setQuickFilter($('#searchFeild').val());
		});
	}

	function initTable(stocks) {
		// Add stocks
		stocks.forEach(function (stock) {
			fields = stock['fields'];
			rowData.push({
				symbol: stock['pk'],
				price: fields['price'],
				change: (fields['change'] < 0 ? '▼ ' : '▲ ') + fields['change'] + '%'
			});
		});

		// Show the grid
		new agGrid.Grid($('.index #buytable')[0], gridOptions);
		gridOptions.api.sizeColumnsToFit();
	}

</script>
{% endblock scripts %}
