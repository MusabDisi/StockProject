{% extends "base.html" %}
{% block content %}
<!-- Chart library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
<!-- Autocomplete libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- Add stock section -->
<h3>Add a stock</h3>

<div class="searchSection">

	<div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
		<label class="mdl-button mdl-js-button mdl-button--icon" for="searchFeild">
			<i class="material-icons" style="color:#03a9f4">search</i>
		</label>
		<div class="mdl-textfield__expandable-holder">
			<input class="mdl-textfield__input" type="text" id="searchFeild">
			<label class="mdl-textfield__label" for="sample-expandable">Search for stock</label>
		</div>
	</div>
	<button id="addStock" disabled class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
		Add stock</button>
</div>


<!-- Progress bar -->
<div id="progress" class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>

<!-- Timeline prices chart -->
<h1>Prices timeline</h1>
<canvas id="chart"></canvas>
<nav class="timeline" aria-label="Page navigation example">
	<ul class="pagination">
		<li class="page-item"><a class="page-link" href="#">1D</a></li>
		<li class="page-item"><a class="page-link" href="#">5D</a></li>
		<li class="page-item"><a class="page-link" href="#">1M</a></li>
		<li class="page-item"><a class="page-link" href="#">3M</a></li>
		<li class="page-item"><a class="page-link" href="#">6M</a></li>
		<li class="page-item"><a class="page-link" href="#">1Y</a></li>
		<li class="page-item"><a class="page-link" href="#">Max</a></li>
	</ul>
</nav>

<!-- Today prices chart -->
<hr>
<h1>Today's value</h1>
<canvas id="todayChart"></canvas>


<style>
	.searchSection {
		text-align: left;
		max-height: 200px;
		overflow-y: auto;
		overflow-x: hidden;
	}

	#addStock {
		background-color: grey;
		display: inline-block;
		color: white;
		margin: 8px;
		text-transform: none;
	}

	h1,
	h3 {
		text-align: left;
		color: black;
	}

	.timeline {
		display: inline-block;
		margin: 0 auto;
	}

	#progress {
		width: 100%;
	}

	.progressWrapper {
		width: 40px;
	}

	canvas {
		width: 100%;
		height: 400px;
	}
</style>

<script>
	const stocksRaw = "{{ stocks|escapejs }}";
	var timelineChart = null;
	var todayPriceChart = null;
	const stocksColors = [];

	$(document).ready(function () {
		requestData('1M');
		$("ul li a").on("click", function () {
			requestData(this.innerText);
		});

		initSearch();
	});

	function initSearch() {
		$.get("/api/stocks_names_and_symbols/", function () {
		}).done(function (data) {
			$('#searchFeild').autocomplete({
				source: function (request, response) {
					var results = $.ui.autocomplete.filter(data.data, request.term);
					response(results.slice(0, 10));
				}
			}, { select: onSearchDataChanged });
			$("#searchFeild").keyup(onSearchDataChanged);
		}).fail(function () {
			console.log('err');
		});


		$('#addStock').click(function () {
			stockSympol = $("#searchFeild").val().split('-')[0];
			currentURL = window.location.href.replace('#', '');
			window.location.href = currentURL + '-' + stockSympol;
		});
	}

	function onSearchDataChanged() {
		if ($("#searchFeild").val().trim().length == 0) {
			$('#addStock').prop('disabled', true);
			$('#addStock').css('background-color', 'grey');
		} else {
			$('#addStock').prop('disabled', false);
			$('#addStock').css('background-color', '#03a9f4');
		}
	}

	function requestData(interval) {
		// Reset colors
		$("ul li a").css('background-color', 'white');
		$("ul li a").css('color', '#2d7df6');
		// Highlight selected
		$("ul li a:contains('" + interval + "')").css('background-color', '#2d7df6');
		$("ul li a:contains('" + interval + "')").css('color', 'white');
		if (timelineChart != null) timelineChart.destroy();

		$('#progress').css('visibility', 'visible');
		$('.timeline').css('visibility', 'hidden');

		$.get("/api/multi_historic/" + stocksRaw + "/" + interval, function () {
		}).done(function (data) {
			reflectDataOnCharts(data.data);
			$('#progress').css('visibility', 'hidden');
			$('.timeline').css('visibility', 'visible');
		}).fail(function () {
			console.log('err');
		});
	}

	function buildStocksColors(data) {
		for (datum of data)
			stocksColors.push(getRandomColor());
	}

	function reflectDataOnCharts(data) {
		// Build stock colors
		if (stocksColors.length == 0) buildStocksColors(data);

		// Build timeline chart
		var ctx = $('#chart')[0].getContext('2d');
		timelineChart = new Chart(ctx, {
			type: 'line',
			data: {
				labels: data[0].data.map(d => d.label),
				datasets: getDataSet(data)
			},
			options: {}
		});

		// Build today's prices chart
		if (todayPriceChart == null)
			todayPriceChart = new Chart($('#todayChart')[0].getContext('2d'), {
				type: 'bar',
				data: {
					labels: data.map(d => d.name),
					datasets: [{
						label: 'Stock price',
						data: data.map(d => d.data[0].low),
						backgroundColor: stocksColors.map(color => ("#80" + color)),
						borderColor: stocksColors.map(color => ("#FF" + color)),
						borderWidth: 1
					}]
				},
				options: { scales: { yAxes: [{ ticks: { beginAtZero: true } }] }, legend: { display: false } }
			});
	}

	function getDataSet(stocks) {
		list = [];
		var i = 0;
		for (stock of stocks) {
			list.push({
				label: stock.name,
				borderColor: 'blue',
				data: stock.data.map(d => d.low),
			});
		}

		return list;
	}

	function getRandomColor() {
		var letters = '0123456789ABCDEF';
		var color = '';
		for (var i = 0; i < 6; i++) {
			color += letters[Math.floor(Math.random() * 16)];
		}
		return color;
	}

</script>

{% endblock %}